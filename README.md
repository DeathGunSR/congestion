# Network Congestion Prediction using LSTM

This project uses a Long Short-Term Memory (LSTM) neural network to predict network congestion by analyzing `.pcap` traffic files. The system aggregates traffic data into fixed time intervals (0.5 seconds) and uses a sequence of the last 5 seconds of data to predict congestion in the next second.

## Project Structure

- `pcap_parser.py`: A script to parse a `.pcap` file, aggregate features into 0.5-second intervals, and save them as a CSV.
- `train_model.py`: A script to train the LSTM model on the aggregated time-series data.
- `predict.py`: A script to make congestion predictions on new `.pcap` files using the trained model.
- `requirements.txt`: A list of all the Python dependencies (`scapy`, `pandas`, `tensorflow`, `matplotlib`, etc.).
- `congestion_model.keras`: The saved, trained model file (generated by `train_model.py`).
- `scaler.gz`: The saved scaler object for data normalization (generated by `train_model.py`).

## How to Use

### 1. Installation

First, install the necessary Python libraries:

```bash
pip install -r requirements.txt
```

### 2. Training the Model

You must train the model on your own network traffic data for accurate predictions.

1.  **Place your data:** Put a `.pcap` file containing the traffic you want to train on in the root directory of this project. Let's call it `training_traffic.pcap`.

2.  **Update the parser script:** Open `pcap_parser.py` and change the `PCAP_FILE` variable to match the name of your file.

    ```python
    # in pcap_parser.py
    PCAP_FILE = 'training_traffic.pcap'
    ```

3.  **Run the parser:** Execute the parser script. It will ask for the IP address of the machine where the capture was taken (the "laptop"). This IP is used to calculate RTT correctly.

    ```bash
    python pcap_parser.py
    ```
    This will generate a `processed_data.csv` file, with data aggregated into 5-second intervals.

4.  **Run the training script:** Now, you can train the model on the aggregated data.

    ```bash
    python train_model.py
    ```
    This script trains a new model and saves it as `congestion_model.keras` and the corresponding feature scaler as `scaler.gz`.

### 3. Making a Prediction from a File

Once the model is trained, you can predict congestion on a `.pcap` file.

```bash
python predict.py /path/to/your/new_capture.pcap --ip YOUR_LAPTOP_IP
```

- Replace `/path/to/your/new_capture.pcap` with the path to your file.
- Replace `YOUR_LAPTOP_IP` with the local IP of the machine where the capture was taken.

The script will process the file, use the last 5 seconds of traffic data (10 intervals of 0.5 seconds) to predict the average RTT 1 second into the future, and output a corresponding congestion status.

### 4. Real-Time Congestion Prediction

This is the most advanced feature of the project. This script will listen to live network traffic on one of your machine's network interfaces and predict congestion in real-time.

**A. Find Your Network Interface Name**

You need to tell the script which network interface to listen on. Run the `realtime_predictor.py` script without the `--iface` argument to see a list of available interfaces.

```bash
python realtime_predictor.py --ip YOUR_LAPTOP_IP
```

Look for the one that corresponds to your Wi-Fi or Ethernet connection.
- On **Linux/macOS**, it might be `wlan0`, `en0`, etc.
- On **Windows**, it will be a longer name like `Wi-Fi` or `Ethernet`.

**B. Run the Real-Time Predictor**

Once you have your interface name, run the script with both the `--ip` and `--iface` arguments.

```bash
# Example for Linux/macOS
sudo python realtime_predictor.py --ip 192.168.1.103 --iface wlan0

# Example for Windows
# You may need to run your terminal as an Administrator
python realtime_predictor.py --ip 192.168.1.103 --iface "Wi-Fi"
```

**Note:** Live packet sniffing requires elevated privileges. You will likely need to run this command with `sudo` on Linux/macOS or in an Administrator terminal on Windows.

The script will start sniffing packets and, after collecting enough initial data (5 seconds worth), it will begin printing a new prediction every 0.5 seconds and updating a live plot. Press `Ctrl+C` to stop the script.

A plot window will open, showing a live comparison between the actual measured RTT and the RTT predicted by the model, allowing for a direct visual assessment of the model's accuracy.

---

## تشریح دقیق متدولوژی پیش‌بینی ازدحام

این بخش به صورت دقیق و با جزئیات، روند علمی و فنی این پروژه را برای استفاده در مقالات و پایان‌نامه‌ها تشریح می‌کند.

### هدف اصلی: پیش‌بینی ازدحام شبکه

هدف این سیستم، پیش‌بینی وضعیت ازدحام شبکه در آینده‌ای نزدیک (مثلاً ۵ ثانیه آینده) بر اساس تحلیل ترافیک شبکه در گذشته (مثلاً ۶۰ ثانیه گذشته) است. به جای تشخیص صرفِ ازدحام در لحظه، ما به دنبال یک سیستم پیش‌نگر هستیم که بتواند وقوع ازدحام را قبل از تشدید آن هشدار دهد.

### شاخص کلیدی برای ازدحام: زمان رفت و برگشت (RTT)

در شبکه‌های کامپیوتری، ازدحام (Congestion) زمانی رخ می‌دهد که حجم ترافیک ورودی به یک نود (مانند روتر) از ظرفیت پردازشی یا پهنای باند خروجی آن بیشتر باشد. این پدیده منجر به پر شدن بافرها و در نتیجه، افزایش **تاخیر** در ارسال پکت‌ها می‌شود.

مستقیم‌ترین و قابل‌اندازه‌گیری‌ترین شاخص برای این تاخیر، **زمان رفت و برگشت (Round-Trip Time - RTT)** است. RTT نشان‌دهنده مدت زمانی است که یک پکت از مبدا به مقصد رفته و پاسخ آن بازمی‌گردد. افزایش قابل توجه در میانگین RTT، یک سیگنال بسیار قوی از وجود ازدحام در مسیر شبکه است. بنابراین، این پروژه RTT را به عنوان **متغیر هدف (Target Variable)** برای پیش‌بینی انتخاب کرده است.

### فرآیند آماده‌سازی داده‌ها

داده‌های خام شبکه (پکت‌ها) باید به یک فرمت ساختاریافته و مناسب برای مدل یادگیری ماشین تبدیل شوند. این فرآیند شامل مراحل زیر است:

**۱. استخراج ویژگی‌های پایه:**
ابتدا پکت‌ها (از فایل `.pcap` یا به صورت زنده) خوانده شده و ویژگی‌های اصلی هر پکت استخراج می‌شود:
- **Timestamp:** زمان دقیق رسیدن پکت.
- **Length:** اندازه پکت بر حسب بایت.
- **RTT:** برای پکت‌های TCP، با تطبیق شماره توالی (Sequence Number) یک پکت ارسالی با شماره تصدیق (Acknowledgment Number) پکت بازگشتی، RTT محاسبه می‌شود.

**۲. agregat کردن داده‌ها در بازه‌های زمانی ثابت (Time Series Aggregation):**
تحلیل پکت به پکت برای پیش‌بینی ازدحام می‌تواند بسیار نویزی و محاسباتی باشد. یک رویکرد بهتر، بررسی رفتار کلی شبکه در بازه‌های زمانی کوتاه و ثابت است. در این پروژه، ما ترافیک را در بازه‌های **۵ ثانیه‌ای** جمع‌آوری می‌کنیم. برای هر بازه، ویژگی‌های زیر محاسبه می‌شوند:
- `packet_count`: تعداد کل پکت‌های مشاهده شده در بازه.
- `length`: مجموع حجم داده‌های منتقل شده (به بایت) در بازه.
- `rtt`: میانگین RTT محاسبه شده برای تمام پکت‌های TCP در آن بازه.

این کار داده‌ها را از یک سری زمانی نامنظم (بر اساس زمان رسیدن هر پکت) به یک سری زمانی منظم و یکنواخت (یک نقطه داده به ازای هر ۵ ثانیه) تبدیل می‌کند.

### معماری مدل: شبکه عصبی بازگشتی LSTM

برای پیش‌بینی مقادیر آینده یک سری زمانی، شبکه‌های عصبی بازگشتی (RNNs) انتخاب بسیار مناسبی هستند. به طور خاص، ما از معماری **Long Short-Term Memory (LSTM)** استفاده کرده‌ایم.

**چرا LSTM؟**
شبکه‌های LSTM به دلیل داشتن "حافظه بلندمدت" و "کوتاه‌مدت"، توانایی فوق‌العاده‌ای در به خاطر سپردن الگوهای مهم در دنباله‌های طولانی دارند. آن‌ها می‌توانند الگوهای پیچیده‌ای را یاد بگیرند؛ مثلاً اینکه چگونه ترکیبی از افزایش تعداد پکت‌ها و کاهش حجم داده در چند بازه زمانی گذشته، به طور معمول منجر به افزایش RTT در بازه زمانی آینده می‌شود.

**آماده‌سازی داده برای مدل:**
ورودی مدل LSTM باید به صورت دنباله‌هایی از داده‌های گذشته باشد. ما از یک پنجره لغزان (Sliding Window) برای این کار استفاده می‌کنیم:
- **`SEQUENCE_LENGTH = 12`**: ما ۱۲ بازه زمانی ۵ ثانیه‌ای گذشته (مجموعاً ۶۰ ثانیه) را به عنوان یک دنباله ورودی در نظر می‌گیریم.
- **`PREDICTION_HORIZON = 1`**: هدف مدل، پیش‌بینی میانگین RTT برای ۱ بازه زمانی بعدی (۵ ثانیه آینده) است.

بنابراین، مدل یاد می‌گیرد که با دیدن داده‌های ۶۰ ثانیه گذشته، RTT را برای ۵ ثانیه آینده پیش‌بینی کند.

### فرآیند پیش‌بینی و تفسیر نتایج

پس از آموزش، مدل برای پیش‌بینی زنده استفاده می‌شود:
۱. در هر ۵ ثانیه، داده‌های ترافیک جمع‌آوری و یک سطر جدید از ویژگی‌های agregat شده تولید می‌شود.
۲. این سطر جدید به انتهای یک دنباله از ۱۱ سطر قبلی اضافه می‌شود تا یک دنباله کامل ۱۲ تایی شکل گیرد.
۳. این دنباله به مدل داده شده و مدل، میانگین RTT را برای ۵ ثانیه آینده پیش‌بینی می‌کند.
۴. مقدار RTT پیش‌بینی‌شده با آستانه‌های از پیش تعیین‌شده مقایسه شده و وضعیت ازدحام به صورت کیفی ("پایدار"، "متوسط" یا "شدید") به کاربر نمایش داده می‌شود. این آستانه‌ها می‌توانند بر اساس تحلیل ترافیک واقعی شبکه تنظیم شوند تا دقت بیشتری داشته باشند.

این متدولوژی یک رویکرد استاندارد و قدرتمند برای مسائل پیش‌بینی مبتنی بر سری‌های زمانی است که به خوبی برای تحلیل ترافیک شبکه و پیش‌بینی ازدحام به کار گرفته شده است.
